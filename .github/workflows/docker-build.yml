name: Docker Build & Test

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov

    - name: Run unit tests
      run: |
        # Run tests if they exist
        if [ -d "baseline_v1_live/tests" ]; then
          pytest baseline_v1_live/tests/ -v --cov=baseline_v1_live
        else
          echo "No tests found - skipping"
        fi

  docker-build:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build trading agent Docker image
      run: |
        docker build -t baseline_v1_live:test .

    - name: Build monitor dashboard Docker image
      run: |
        docker build -t trading_monitor:test ./baseline_v1_live/monitor_dashboard/

    - name: Test trading agent container starts
      run: |
        # Start container with test command (just check imports work)
        docker run --rm baseline_v1_live:test python -c "from baseline_v1_live import config; print('Config loaded successfully')"

  docker-compose-test:
    runs-on: ubuntu-latest
    needs: docker-build

    steps:
    - uses: actions/checkout@v3

    - name: Create test .env files
      run: |
        # Root .env for trading_agent
        cat > .env << 'EOF'
        OPENALGO_API_KEY=test_key
        OPENALGO_HOST=http://openalgo:5000
        PAPER_TRADING=true
        EXPIRY=30JAN26
        ATM=23500
        TOTAL_CAPITAL=10000000
        EOF

        # OpenAlgo .env (required for docker-compose build)
        mkdir -p openalgo-zerodha/openalgo
        cat > openalgo-zerodha/openalgo/.env << 'EOF'
        BROKER_API_KEY=test_key
        BROKER_API_SECRET=test_secret
        REDIRECT_URL=http://localhost:5000/callback
        HOST_SERVER=http://localhost:5000
        EOF

    - name: Validate docker-compose syntax
      run: |
        docker compose config --quiet && echo "docker-compose.yaml is valid"

    - name: Build all services (excluding openalgo - needs full source)
      run: |
        # Build only trading_agent and monitor (openalgo needs full source code)
        docker compose build trading_agent monitor || echo "Build completed with warnings"

    # Note: Full integration testing requires real OpenAlgo instance
    # Use EC2 staging environment for end-to-end tests
